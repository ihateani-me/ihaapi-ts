<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>VTubers Schedules - ihateani.me</title>
    <meta name="description" content="VTuber Stream Schedules data using ihateani.me API v2">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- OpenGraph -->
    <meta property="og:title" content="VTuber Schedules">
    <meta property="og:description" content="VTuber Stream Schedules data using ihateani.me API v2">
    <meta property="og:url" content="https://api.ihateani.me/v2/vtuber/">
    <meta property="og:site_name" content="ihateani.me API">
    <meta property="og:image" content="/assets/favicon.png">
    <meta property="og:type" content="website">
    <meta name="theme-color" content="#383838">

    <link rel="icon" type="image/png" href="/assets/favicon.png">
    <link rel="icon" href="/assets/favicon.ico">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-giJF6kkoqNQ00vy+HMDP7azOuL0xtbfIcaT9wjKHr8RbDVddVHyTfAAsrekwKmP1" crossorigin="anonymous">
    <link href="/assets/css/nao-iconsv2.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css" rel="stylesheet" />
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap" rel="stylesheet" />
    <!-- MDB -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/mdb-ui-kit/3.0.0/mdb.min.css" rel="stylesheet" />
    <link href="/assets/css/nao-iconsv2.css" rel="stylesheet">
    <!-- <script defer src="https://use.fontawesome.com/releases/v5.15.1/js/solid.js"
        integrity="sha384-oKbh94nlFq571cjny1jaIBlQwzTJW4KYExGYjslYSoG/J/w68zUI+KHPRveXB6EY" crossorigin="anonymous">
    </script>
    <script defer src="https://use.fontawesome.com/releases/v5.15.1/js/brands.js"
        integrity="sha384-GUtlu2Qit8cdodM5DbKnbDIWFJA8nWCVEwETZXY2xvKV1TFLtD/AL+bCOsPyh05M" crossorigin="anonymous">
    </script>
    <script defer src="https://use.fontawesome.com/releases/v5.15.1/js/fontawesome.js"
        integrity="sha384-v0OPwyxrMWxEgAVlmUqvjeEr48Eh/SOZ2DRtVYJCx1ZNDfWBfNMWUjwUwBCJgfO4" crossorigin="anonymous"> -->

    <style>
        .border-twitch {
            border-color: #8E42FE !important;
        }

        .bg-darkgrey,
        .btn-darkgrey {
            background-color: #2a2d2f !important;
        }

        .btn-darkgrey:hover,
        .btn-darkgrey:active,
        .btn-darkgrey:focus {
            background-color: #35383a !important;
        }

        .text-darkgrey {
            color: #2a2d2f !important;
        }

        .text-twitch {
            color: #8E42FE !important;
        }

        .floating-btn {
            position: fixed;
            width: 60px;
            height: 60px;
            bottom: 40px;
            right: 40px;
            background-color: #c50909;
            color: #FFF;
            border-radius: 50px;
            text-align: center;
            box-shadow: 0px 0px 5px 0px #2A2D2F;
            border-color: transparent;
            z-index: 999;
        }
    </style>
    <style type="text/css">
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-button {
            width: 0px;
            height: 0px;
        }

        ::-webkit-scrollbar-thumb {
            background: #4d4d4d;
            border: 3px none #808080;
            border-radius: 50px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #7a7a7a;
        }

        ::-webkit-scrollbar-thumb:active {
            background: #2e2e2e;
        }

        ::-webkit-scrollbar-track {
            background: #707070;
            border: 0px none #ffffff;
            border-radius: 100px;
        }

        ::-webkit-scrollbar-track:hover {
            background: #666666;
        }

        ::-webkit-scrollbar-track:active {
            background: #666666;
        }

        ::-webkit-scrollbar-corner {
            background: transparent;
        }
    </style>
</head>

<body class="bg-darkgrey">
    <nav id="main-nav" class="navbar navbar-expand-lg navbar-dark bg-dark sticky-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">VTuber API</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
                data-bs-target="#navbarNavDarkDropdown" aria-controls="navbarNavDarkDropdown" aria-expanded="false"
                aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNavDarkDropdown">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="/v2/vtuber">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/v2/vtuber/lives">Lives</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" aria-current="page" href="#">Schedule</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/v2/graphql"><i class="nico-graphql me-1"></i>Playground</a>
                    </li>
                </ul>
            </div>
            <a href="/v2/vtuber/admin" class="btn btn-darkgrey text-white"><i class="fas fa-sign-in-alt fs-6"></i></a>
        </div>
    </nav>
    <div id="main" class="container-fluid mt-4 pb-4">
        <div id="loading-signal" class="text-center">
            <div class="spinner-grow text-white" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p id="loading-text" class="mt-2 text-white">Loading...</p>
        </div>
        <div id="group-modal" class="modal fade" tabindex="-1">
            <div class="modal-dialog modal-dialog-scrollable">
                <div class="modal-content bg-dark text-white">
                    <div class="modal-header border-dark">
                        <h5 class="modal-title">Groups</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                            aria-label="Close"></button>
                    </div>
                    <div class="modal-body text-center">
                        <div id="group-modal-grid" class="d-grid gap-2">
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <button id="group-btn-modal" type="button" data-bs-toggle="modal" data-bs-target="#group-modal"
            class="floating-btn">
            <i class="nico-users"></i>
            </a>
    </div>
    <footer class="text-center text-lg-start text-muted">
        <hr>
        <div class="text-center p-3" class="bg-darkgrey">
            Created by <b>N4O#8868</b><br>
            Â© 2020-2021
            <a class="text-white" href="https://ihateani.me/">ihateani.me</a>
        </div>
    </footer>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ygbV9kiqUc6oa4msXn9868pTtWMgiQaeYH7/t7LECLbyPA2x65Kgf80OJFdroafW" crossorigin="anonymous">
    </script>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"
        integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@1.25.0/build/global/luxon.min.js"
        integrity="sha256-OVk2fwTRcXYlVFxr/ECXsakqelJbOg5WCj1dXSIb+nU=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload@17.3.0/dist/lazyload.min.js"></script>
    <script type="text/javascript">
        "use strict"

        const $dropdown = $("#group-dropdown");
        const $main = $("#main");
        const $loader = $("#loading-signal");
        const $gridModal = $("#group-modal-grid");
        var fetchedPage = 0;
        const DateTime = luxon.DateTime;
        const localZone = DateTime.local().zoneName;

        let gqlSchemas = `query VTuberSchedule($cursor:String) {
            vtuber {
                upcoming(cursor:$cursor,limit:75,platforms:[youtube]) {
                    _total
                    items {
                        id
                        title
                        channel {
                            id
                            name
                            image
                        }
                        timeData {
                            scheduledStartTime
                        }
                        thumbnail
                        platform
                        is_premiere
                        group
                    }
                    pageInfo {
                        results_per_page
                        hasNextPage
                        nextCursor
                    }
                }
            }
        }`;

        let GROUPS_NAME_MAP = {
            "animare": "Animare",
            "axel-v": "AXEL-V",
            "cattleyarg": "Cattleya Regina Games",
            "dotlive": ".LIVE",
            "eilene": "Eilene",
            "entum": "ENTUM",
            "hanayori": "Hanayori",
            "hololive": "Hololive",
            "hololiveen": "Hololive English",
            "hololivecn": "Hololive China",
            "hololiveid": "Hololive Indonesia",
            "holostars": "Holostars",
            "honeystrap": "Honeystrap",
            "irisbg": "Iris Black Games",
            "kamitsubaki": "KAMITSUBAKI Studio",
            "kizunaai": "Kizuna Ai Co.",
            "lupinusvg": "Lupinus Video Games",
            "mahapanca": "MAHA5",
            "nijisanji": "NIJISANJI",
            "nijisanjiid": "NIJISANJI Indonesia",
            "nijisanjiin": "NIJISANJI India",
            "nijisanjikr": "NIJISANJI Korea",
            "nijisanjien": "NIJISANJI English",
            "noriopro": "Norio Production",
            "paryiproject": "Paryi Project",
            "solovtuber": "Solo/Indie",
            "sugarlyric": "SugarLyric",
            "upd8": "upd8",
            "vapart": "VAPArt",
            "veemusic": "VEEMusic",
            "vgaming": "VGaming",
            "vic": "VIC",
            "virtuareal": "VirtuaReal",
            "vivid": "ViViD",
            "voms": "VOMS",
            "vshojo": "VShojo"
        }

        // Modified version of:
        // https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/reduce#Grouping_objects_by_a_property
        function groupBy(objectArray, property) {
            return objectArray.reduce(function (acc, obj) {
                let key;
                if (typeof property === "function") {
                    key = property(obj);
                } else {
                    key = obj[property];
                }
                if (!acc[key]) {
                    acc[key] = []
                }
                acc[key].push(obj)
                return acc
            }, {})
        }

        // https://github.com/you-dont-need/You-Dont-Need-Lodash-Underscore#_get
        function get(obj, path, defaults = undefined) {
            const travel = regexp =>
                String.prototype.split
                .call(path, regexp)
                .filter(Boolean)
                .reduce((res, key) => (res !== null && res !== undefined ? res[key] : res), obj);
            const result = travel(/[,[\]]+?/) || travel(/[,[\].]+?/);
            return result === undefined || result === obj ? defaults : result;
        }

        // Modified version of:
        // https://github.com/you-dont-need/You-Dont-Need-Lodash-Underscore#_sortby-and-_orderby
        function sortBy(data, key_or_func) {
            if (typeof data === "undefined" || data === null) {
                return data;
            }
            if (data.length < 1) {
                return data;
            }
            let result = data.concat().sort((a, b) => {
                let a1, b1;
                if (typeof key_or_func === "function") {
                    a1 = key_or_func(a);
                    b1 = key_or_func(b);
                } else {
                    a1 = a[key_or_func];
                    b1 = b[key_or_func];
                }
                return (a1 > b1) ? 1 : ((b1 > a1) ? -1 : 0);
            })
            return result;
        }

        const getLives = async function (cursor = "") {
            let apiRes = await fetch("https://api.ihateani.me/v2/graphql", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Accept": "application/json"
                },
                body: JSON.stringify({
                    query: gqlSchemas,
                    variables: {
                        cursor: cursor
                    }
                })
            }).then((res) => res.json());
            return apiRes;
        }

        const getAllLivesAsync = async function (cursor = "") {
            let results = await getLives(cursor);
            let gqlres = results.data.vtuber;
            fetchedPage++;
            let expectedTotal = Math.ceil(gqlres.upcoming._total / gqlres.upcoming.pageInfo.results_per_page);
            $("#loading-text").text(`Loading (${fetchedPage}/${expectedTotal})...`);

            let mainResults = gqlres.upcoming.items;

            let pageData = gqlres.upcoming.pageInfo;
            if (pageData.hasNextPage && pageData.nextCursor) {
                console.log(`[API] Next page detected, paginating...`);
                return mainResults.concat(await getAllLivesAsync(pageData.nextCursor));
            } else {
                return mainResults;
            }
        }

        function createCard(channelInfo) {
            // console.log(channelInfo);
            let $chanCol = $(`<div class="col-sm-6" />`);
            let $cardMain, watchUrl;
            if (channelInfo.platform === "youtube") {
                $cardMain = $(`<div class="card border-danger text-white bg-dark" />`);
                watchUrl = `https://youtube.com/watch?v=${channelInfo.id}`;
            }
            let $linkClick = $(`<a href="${watchUrl}" target="_blank" rel="noopener" />`)
                .append($(`<img class="card-img-top lazy" />`).attr("data-src", channelInfo.thumbnail).attr("alt",
                    "Thumbnail"));
            $cardMain.append($linkClick);
            let $cardMainBody = $(`<div class="card-body" />`);
            let is_premiere = get(channelInfo, "is_premiere", false);
            if (channelInfo.platform === "youtube") {
                $cardMainBody.append($(`<i class="nico-youtube mx-1 text-danger" />`));
                if (is_premiere) {
                    $cardMainBody.append($(`<i class="nico-play mx-1 text-info" />`));
                }
                $cardMainBody.append($(`<span />`).text(is_premiere ? "YouTube (Premiere)" : "YouTube"));
            }

            $cardMainBody.append($(`<h5 class="card-title" />`).text(channelInfo.title));
            $cardMainBody.append($(`<p class="card-subtitle"><b>Streamer:</b> ${channelInfo.channel.name}</p>`));
            let startTimeTZ = DateTime.fromSeconds(channelInfo.timeData.scheduledStartTime, {
                zone: "UTC"
            }).setZone(localZone);
            let startTimeTXT = startTimeTZ.toFormat("EEE, dd MMM yyyy HH:mm:ss ZZZZ");
            let $statsCard = $(
                `<p class="card-text"><b>Start:</b> ${startTimeTXT}</p>`
            );

            let $linkCard = $(
                    `<a class="btn btn-danger" href="${watchUrl}" role="button" rel="noopener" target="_blank" />`)
                .text("Watch");
            $cardMainBody.append($statsCard);
            $cardMainBody.append($linkCard);
            $cardMain.append($cardMainBody);

            $chanCol.append($cardMain)
            // $cardMain.appendTo($groupRows);
            return $chanCol;
        }

        function generateColumn(groupName, groupData) {
            let $topDiv = $(`<div id="${groupName}" class="container-fluid pb-3" />`);
            $topDiv.append($(
                `<h2 class="text-white py-3">${GROUPS_NAME_MAP[groupName]} <span class="badge bg-danger fs-5 fw-normal">${groupData.length}</span></h2>`
            ));
            let $groupRows = $(`<div class="row row-cols-1 row-cols-md-2 g-4" />`);
            let liveCards = sortBy(groupData, function (o) {
                return o.timeData.scheduledStartTime;
            }).map(createCard);
            liveCards.forEach(($card) => {
                $groupRows.append($card);
            })
            $topDiv.append($groupRows);
            return $topDiv;
        }

        (async () => {
            console.log("[API] Fetching all channels data...");
            const channelsSets = await getAllLivesAsync();
            console.log("[API] Grouping results...");
            let unsortedGroupedData = groupBy(channelsSets, "group");
            let groupedData = {};
            Object.keys(unsortedGroupedData).sort().forEach(function (key) {
                groupedData[key] = unsortedGroupedData[key];
            })
            let allJQData = [];

            Object.keys(groupedData).sort().forEach(function (group) {
                $gridModal.append($(
                    `<a class="btn btn-dark btn-darkgrey" href="#${group}" role="button">${GROUPS_NAME_MAP[group]} <span class="badge bg-danger mx-1 rounded-0">${groupedData[group].length}</span></a>`
                ));
            })

            for (let key in groupedData) {
                let value = groupedData[key];
                let $r = generateColumn(key, value);
                allJQData.push($r);
            }
            $loader.fadeOut(500);
            allJQData.forEach(($jqd) => {
                $jqd.show();
                $main.append($jqd);
            })

            var lazyLoadInstance = new LazyLoad({});
            lazyLoadInstance.update();
        })();
    </script>
</body>

</html>