<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>VTubers Admin Dashboard - ihateani.me</title>
    <meta name="description" content="VTuber API Admin Dashboard">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- OpenGraph -->
    <meta property="og:title" content="VTuber Lives">
    <meta property="og:description" content="VTuber API Admin Dashboard">
    <meta property="og:url" content="https://api.ihateani.me/v2/vtuber/admin">
    <meta property="og:site_name" content="ihateani.me API">
    <meta property="og:image" content="/assets/favicon.png">
    <meta property="og:type" content="website">
    <meta name="theme-color" content="#383838">

    <link rel="icon" type="image/png" href="/assets/favicon.png">
    <link rel="icon" href="/assets/favicon.ico">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-giJF6kkoqNQ00vy+HMDP7azOuL0xtbfIcaT9wjKHr8RbDVddVHyTfAAsrekwKmP1" crossorigin="anonymous">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css" rel="stylesheet" />
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap" rel="stylesheet" />
    <!-- MDB -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/mdb-ui-kit/3.0.0/mdb.min.css" rel="stylesheet" />
    <link href="/assets/css/nao-iconsv2.css" rel="stylesheet">
    <!-- <script defer src="https://use.fontawesome.com/releases/v5.15.1/js/solid.js"
        integrity="sha384-oKbh94nlFq571cjny1jaIBlQwzTJW4KYExGYjslYSoG/J/w68zUI+KHPRveXB6EY" crossorigin="anonymous">
    </script>
    <script defer src="https://use.fontawesome.com/releases/v5.15.1/js/brands.js"
        integrity="sha384-GUtlu2Qit8cdodM5DbKnbDIWFJA8nWCVEwETZXY2xvKV1TFLtD/AL+bCOsPyh05M" crossorigin="anonymous">
    </script>
    <script defer src="https://use.fontawesome.com/releases/v5.15.1/js/fontawesome.js"
        integrity="sha384-v0OPwyxrMWxEgAVlmUqvjeEr48Eh/SOZ2DRtVYJCx1ZNDfWBfNMWUjwUwBCJgfO4" crossorigin="anonymous"> -->
    </script>

    <style>
        .border-twitch {
            border-color: #8E42FE !important;
        }

        .bg-darkgrey,
        .btn-darkgrey {
            background-color: #2a2d2f !important;
        }

        .btn-darkgrey:hover,
        .btn-darkgrey:active,
        .btn-darkgrey:focus {
            background-color: #35383a !important;
        }

        .text-darkgrey {
            color: #2a2d2f !important;
        }

        .text-twitch {
            color: #8E42FE !important;
        }

        .text-twcast {
            color: #027AF8 !important;
        }

        .border-twcast {
            border-color: #027AF8 !important;
        }

        .floating-btn {
            position: fixed;
            width: 60px;
            height: 60px;
            bottom: 40px;
            right: 40px;
            background-color: #c50909;
            color: #FFF;
            border-radius: 50px;
            text-align: center;
            box-shadow: 0px 0px 5px 0px #2A2D2F;
            border-color: transparent;
            z-index: 999;
        }
    </style>
    <style type="text/css">
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-button {
            width: 0px;
            height: 0px;
        }

        ::-webkit-scrollbar-thumb {
            background: #4d4d4d;
            border: 3px none #808080;
            border-radius: 50px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #7a7a7a;
        }

        ::-webkit-scrollbar-thumb:active {
            background: #2e2e2e;
        }

        ::-webkit-scrollbar-track {
            background: #707070;
            border: 0px none #ffffff;
            border-radius: 100px;
        }

        ::-webkit-scrollbar-track:hover {
            background: #666666;
        }

        ::-webkit-scrollbar-track:active {
            background: #666666;
        }

        ::-webkit-scrollbar-corner {
            background: transparent;
        }
    </style>
</head>

<body class="bg-darkgrey">
    <nav id="main-nav" class="navbar navbar-expand-lg navbar-dark bg-dark sticky-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">VTuber API</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
                data-bs-target="#navbarNavDarkDropdown" aria-controls="navbarNavDarkDropdown" aria-expanded="false"
                aria-label="Toggle navigation">
                <i class="fas fa-bars text-white"></i>
            </button>
            <div class="collapse navbar-collapse justify-content-between" id="navbarNavDarkDropdown">
                <div class="navbar-nav">
                    <a class="nav-link" aria-current="page" href="#">Home</a>
                    <a class="nav-link" href="/v2/vtuber/lives">Lives</a>
                    <a class="nav-link" href="/v2/vtuber/schedules">Schedule</a>
                    <a class="nav-link" href="/v2/graphql"><i class="nico-graphql me-1"></i>Playground</a>
                </div>
                <div class="navbar-nav">
                    <a class="nav-link" href="/v2/vtuber/settings"><i class="fas fa-cog"></i></a>
                    <a class="nav-link active" href="/v2/vtuber/logout"><i class="fas fa-sign-out-alt fs-6"></i></a>
                </div>
            </div>
        </div>
    </nav>
    <div id="main" class="container-fluid mt-4 pb-4 text-white">
        <h2>Welcome!</h2>
        <p>
            This page will allow you to add or remove a VTuber from the Databases<br>
            To remove: Just press the remove button on the channels part.<br>
            To add: Enter the channel link below
        </p>
        <hr>
        <form id="formvtapi-add" action="/v2/vtuber/admin/add" method="POST">
            <div class="row">
                <div class="col-sm-6 mb-3">
                    <label for="channeladd-vtapi" class="form-label text-white">Channel Link</label>
                    <input id="channelUrl" class="form-control" aria-describedby="channelHelp" disabled>
                    <div id="channelHelp" class="form-text">
                        Must be YouTube Channel URL, Twitcasting Channel URL, or Twitch Channel URL
                    </div>
                </div>
                <div class="col-sm-3 mb-3">
                    <label for="channelgroupadd-vtapi" class="form-label text-white">Channel Group</label>
                    <select id="channelGroup" class="form-select" aria-label="Group" disabled>
                        <option selected>Custom</option>
                    </select>
                </div>
                <div class="col-sm-3 mb-3">
                    <label for="channelgroupadd-vtapi" class="form-label text-white">Custom Group</label>
                    <input id="channelGroupCustom" class="form-control" aria-describedby="channelGroupHelp" disabled>
                    <div id="channelGroupHelp" class="form-text">
                        Write group here if you use Custom
                    </div>
                </div>
            </div>
            <div class="d-grid gap-2 d-md-block">
                <button id="btnAddNew" type="submit" class="btn btn-primary" disabled>
                    <span id="btnAddNewSpinner" class="spinner-grow spinner-grow-sm visually-hidden me-2" role="status" aria-hidden="true"></span>
                    <i class="fas fa-plus"></i>&nbsp;&nbsp;Add
                </button>
            </div>
        </form>
        <hr>
        <div id="loading-signal" class="text-center">
            <div class="spinner-grow text-white" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p id="loading-text" class="mt-2 text-white">Loading...</p>
        </div>
        <div id="group-modal" class="modal fade" tabindex="-1">
            <div class="modal-dialog modal-dialog-scrollable">
                <div class="modal-content bg-dark text-white">
                    <div class="modal-header border-dark">
                        <h5 class="modal-title">Groups</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                            aria-label="Close"></button>
                    </div>
                    <div class="modal-body text-center">
                        <div id="group-modal-grid" class="d-grid gap-2">
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div id="error-modal" class="modal fade" tabindex="-1">
            <div class="modal-dialog modal-dialog-scrollable">
                <div class="modal-content bg-dark text-white">
                    <div class="modal-header border-dark">
                        <h5 class="modal-title">Error</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                            aria-label="Close"></button>
                    </div>
                    <div class="modal-body text-center">
                        <p id="error-modal-text"></p>
                    </div>
                </div>
            </div>
        </div>
        <button id="group-btn-modal" type="button" data-bs-toggle="modal" data-bs-target="#group-modal"
            class="floating-btn">
            <i class="nico-users"></i>
            </a>
    </div>
    <footer class="text-center text-lg-start text-muted">
        <hr>
        <div class="text-center p-3" class="bg-darkgrey">
            Created by <b>N4O#8868</b><br>
            Â© 2020-2021
            <a class="text-white" href="https://ihateani.me/">ihateani.me</a>
        </div>
    </footer>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ygbV9kiqUc6oa4msXn9868pTtWMgiQaeYH7/t7LECLbyPA2x65Kgf80OJFdroafW" crossorigin="anonymous">
    </script>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"
        integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@1.25.0/build/global/luxon.min.js"
        integrity="sha256-OVk2fwTRcXYlVFxr/ECXsakqelJbOg5WCj1dXSIb+nU=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload@17.3.0/dist/lazyload.min.js"></script>
    <script type="text/javascript">
        "use strict"

        const $dropdown = $("#group-dropdown");
        const $main = $("#main");
        const $loader = $("#loading-signal");
        const $gridModal = $("#group-modal-grid");
        const errorModal = new bootstrap.Modal(document.getElementById("error-modal"), {});
        const YOUTUBE_RE = /(?:(?:http?s):\/\/)?(?:www\.)?youtube\.com\/(?:channel|user)\/([a-zA-Z0-9\-\_]+)/mi;
        const TWITCH_RE = /(?:(?:http?s):\/\/)?(?:www\.)?twitch\.tv\/([a-zA-Z0-9\-]+)/mi;
        const TWITCASTING_RE = /(?:(?:http?s):\/\/)?(?:www\.)?twitcasting\.tv\/([a-zA-Z0-9\-]+)/mi;
        var fetchedPage = 0;

        let gqlSchemas = `query VTuberChannel($cursor:String) {
            vtuber {
                channels(platforms:[youtube,twitch,twitcasting],cursor:$cursor,limit:75) {
                    _total
                    items {
                        id
                        name
                        image
                        platform
                        group
                        publishedAt
                        statistics {
                            subscriberCount
                            viewCount
                        }
                    }
                    pageInfo {
                        results_per_page
                        hasNextPage
                        nextCursor
                    }
                }
            }
        }`;

        // Modified version of:
        // https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/reduce#Grouping_objects_by_a_property
        function groupBy(objectArray, property) {
            return objectArray.reduce(function (acc, obj) {
                let key;
                if (typeof property === "function") {
                    key = property(obj);
                } else {
                    key = obj[property];
                }
                if (!acc[key]) {
                    acc[key] = []
                }
                acc[key].push(obj)
                return acc
            }, {})
        }

        // https://github.com/you-dont-need/You-Dont-Need-Lodash-Underscore#_get
        function get(obj, path, defaults = undefined) {
            const travel = regexp =>
                String.prototype.split
                .call(path, regexp)
                .filter(Boolean)
                .reduce((res, key) => (res !== null && res !== undefined ? res[key] : res), obj);
            const result = travel(/[,[\]]+?/) || travel(/[,[\].]+?/);
            return result === undefined || result === obj ? defaults : result;
        }

        // Modified version of:
        // https://github.com/you-dont-need/You-Dont-Need-Lodash-Underscore#_sortby-and-_orderby
        function sortBy(data, key_or_func) {
            if (typeof data === "undefined" || data === null) {
                return data;
            }
            if (data.length < 1) {
                return data;
            }
            let result = data.concat().sort((a, b) => {
                let a1, b1;
                if (typeof key_or_func === "function") {
                    a1 = key_or_func(a);
                    b1 = key_or_func(b);
                } else {
                    a1 = a[key_or_func];
                    b1 = b[key_or_func];
                }
                return (a1 > b1) ? 1 : ((b1 > a1) ? -1 : 0);
            })
            return result;
        }

        let GROUPS_NAME_MAP = {
            "animare": "Animare",
            "axel-v": "AXEL-V",
            "cattleyarg": "Cattleya Regina Games",
            "dotlive": ".LIVE",
            "eilene": "Eilene",
            "entum": "ENTUM",
            "hanayori": "Hanayori",
            "hololive": "Hololive",
            "hololiveen": "Hololive English",
            "hololivecn": "Hololive China",
            "hololiveid": "Hololive Indonesia",
            "holostars": "Holostars",
            "honeystrap": "Honeystrap",
            "irisbg": "Iris Black Games",
            "kamitsubaki": "KAMITSUBAKI Studio",
            "kizunaai": "Kizuna Ai Co.",
            "lupinusvg": "Lupinus Video Games",
            "mahapanca": "MAHA5",
            "nijisanji": "NIJISANJI",
            "nijisanjiid": "NIJISANJI Indonesia",
            "nijisanjiin": "NIJISANJI India",
            "nijisanjikr": "NIJISANJI Korea",
            "nijisanjien": "NIJISANJI English",
            "noriopro": "Norio Production",
            "paryiproject": "Paryi Project",
            "solovtuber": "Solo/Indie",
            "sugarlyric": "SugarLyric",
            "upd8": "upd8",
            "vapart": "VAPArt",
            "veemusic": "VEEMusic",
            "vgaming": "VGaming",
            "vic": "VIC",
            "virtuareal": "VirtuaReal",
            "vivid": "ViViD",
            "voms": "VOMS",
            "vshojo": "VShojo"
        }

        const getChannelQuery = async function (cursor = "") {
            let urlFetch = "/v2/graphql";
            if (cursor === "") {
                urlFetch += "?nocache=1&resetcache=1";
            }
            let apiRes = await fetch(urlFetch, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Accept": "application/json"
                },
                body: JSON.stringify({
                    query: gqlSchemas,
                    variables: {
                        cursor: cursor
                    }
                })
            }).then((res) => res.json());
            return apiRes;
        }

        const getAllChannelsAsync = async function (cursor = "") {
            let results = await getChannelQuery(cursor);
            let gqlres = results.data.vtuber;
            fetchedPage++;
            let expectedTotal = Math.ceil(gqlres.channels._total / gqlres.channels.pageInfo.results_per_page);
            $("#loading-text").text(`Loading (${fetchedPage}/${expectedTotal})...`);

            let mainResults = gqlres.channels.items;

            let pageData = gqlres.channels.pageInfo;
            if (pageData.hasNextPage && pageData.nextCursor) {
                console.log(`[API] Next page detected, paginating...`);
                return mainResults.concat(await getAllChannelsAsync(pageData.nextCursor));
            } else {
                return mainResults;
            }
        }

        const PLACEHOLDER_IMG = `data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAfQAAAH0CAIAAABEtEjdAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAawSURBVHhe7dQBDQAADMOgq5l/iffRgAhuAOTIHSBI7gBBcgcIkjtAkNwBguQOECR3gCC5AwTJHSBI7gBBcgcIkjtAkNwBguQOECR3gCC5AwTJHSBI7gBBcgcIkjtAkNwBguQOECR3gCC5AwTJHSBI7gBBcgcIkjtAkNwBguQOECR3gCC5AwTJHSBI7gBBcgcIkjtAkNwBguQOECR3gCC5AwTJHSBI7gBBcgcIkjtAkNwBguQOECR3gCC5AwTJHSBI7gBBcgcIkjtAkNwBguQOECR3gCC5AwTJHSBI7gBBcgcIkjtAkNwBguQOECR3gCC5AwTJHSBI7gBBcgcIkjtAkNwBguQOECR3gCC5AwTJHSBI7gBBcgcIkjtAkNwBguQOECR3gCC5AwTJHSBI7gBBcgcIkjtAkNwBguQOECR3gCC5AwTJHSBI7gBBcgcIkjtAkNwBguQOECR3gCC5AwTJHSBI7gBBcgcIkjtAkNwBguQOECR3gCC5AwTJHSBI7gBBcgcIkjtAkNwBguQOECR3gCC5AwTJHSBI7gBBcgcIkjtAkNwBguQOECR3gCC5AwTJHSBI7gBBcgcIkjtAkNwBguQOECR3gCC5AwTJHSBI7gBBcgcIkjtAkNwBguQOECR3gCC5AwTJHSBI7gBBcgcIkjtAkNwBguQOECR3gCC5AwTJHSBI7gBBcgcIkjtAkNwBguQOECR3gCC5AwTJHSBI7gBBcgcIkjtAkNwBguQOECR3gCC5AwTJHSBI7gBBcgcIkjtAkNwBguQOECR3gCC5AwTJHSBI7gBBcgcIkjtAkNwBguQOECR3gCC5AwTJHSBI7gBBcgcIkjtAkNwBguQOECR3gCC5AwTJHSBI7gBBcgcIkjtAkNwBguQOECR3gCC5AwTJHSBI7gBBcgcIkjtAkNwBguQOECR3gCC5AwTJHSBI7gBBcgcIkjtAkNwBguQOECR3gCC5AwTJHSBI7gBBcgcIkjtAkNwBguQOECR3gCC5AwTJHSBI7gBBcgcIkjtAkNwBguQOECR3gCC5AwTJHSBI7gBBcgcIkjtAkNwBguQOECR3gCC5AwTJHSBI7gBBcgcIkjtAkNwBguQOECR3gCC5AwTJHSBI7gBBcgcIkjtAkNwBguQOECR3gCC5AwTJHSBI7gBBcgcIkjtAkNwBguQOECR3gCC5AwTJHSBI7gBBcgcIkjtAkNwBguQOECR3gCC5AwTJHSBI7gBBcgcIkjtAkNwBguQOECR3gCC5AwTJHSBI7gBBcgcIkjtAkNwBguQOECR3gCC5AwTJHSBI7gBBcgcIkjtAkNwBguQOECR3gCC5AwTJHSBI7gBBcgcIkjtAkNwBguQOECR3gCC5AwTJHSBI7gBBcgcIkjtAkNwBguQOECR3gCC5AwTJHSBI7gBBcgcIkjtAkNwBguQOECR3gCC5AwTJHSBI7gBBcgcIkjtAkNwBguQOECR3gCC5AwTJHSBI7gBBcgcIkjtAkNwBguQOECR3gCC5AwTJHSBI7gBBcgcIkjtAkNwBguQOECR3gCC5AwTJHSBI7gBBcgcIkjtAkNwBguQOECR3gCC5AwTJHSBI7gBBcgcIkjtAkNwBguQOECR3gCC5AwTJHSBI7gBBcgcIkjtAkNwBguQOECR3gCC5AwTJHSBI7gBBcgcIkjtAkNwBguQOECR3gCC5AwTJHSBI7gBBcgcIkjtAkNwBguQOECR3gCC5AwTJHSBI7gBBcgcIkjtAkNwBguQOECR3gCC5AwTJHSBI7gBBcgcIkjtAkNwBguQOECR3gCC5AwTJHSBI7gBBcgcIkjtAkNwBguQOECR3gCC5AwTJHSBI7gBBcgcIkjtAkNwBguQOECR3gCC5AwTJHSBI7gBBcgcIkjtAkNwBguQOECR3gCC5AwTJHSBI7gBBcgcIkjtAkNwBguQOECR3gCC5AwTJHSBI7gBBcgcIkjtAkNwBguQOECR3gCC5AwTJHSBI7gBBcgcIkjtAkNwBguQOECR3gCC5AwTJHSBI7gBBcgcIkjtAkNwBguQOECR3gCC5AwTJHSBI7gBBcgcIkjtAkNwBguQOECR3gCC5AwTJHSBI7gBBcgcIkjtAkNwBguQOECR3gCC5AwTJHSBI7gBBcgcIkjtAkNwBguQOECR3gCC5AwTJHSBI7gBBcgcIkjtAkNwBguQOECR3gCC5AwTJHSBI7gBBcgcIkjtAkNwBguQOECR3gCC5AwTJHSBI7gBBcgcIkjtAkNwBguQOECR3gCC5AwTJHSBI7gBBcgfI2R6HZ/mPRPpNAQAAAABJRU5ErkJggg==`;

        function createCard(channelInfo) {
            let chanStats = channelInfo.statistics;
            // console.log(channelInfo);
            let $chanCol = $(`<div id="${channelInfo.id}-${channelInfo.platform}" class="col" />`);
            let $cardMain, border;
            if (channelInfo.platform === "youtube") {
                border = "border-danger";
                $cardMain = $(`<div class="card border-danger text-white bg-dark" />`);
            } else if (channelInfo.platform === "twitch") {
                border = "border-twitch";
                $cardMain = $(`<div class="card border-twitch text-white bg-dark" />`);
            } else if (channelInfo.platform === "twitcasting") {
                border = "border-twcast";
                $cardMain = $(`<div class="card border-twcast text-white bg-dark" />`);
            }
            $cardMain.append($(`<img class="card-img-top lazy" />`).attr("data-src", channelInfo.image).attr("alt",
                "Profile Picture").attr("src", PLACEHOLDER_IMG));
            let $titleCard = $(`<div class="card-body text-center" />`);
            if (channelInfo.platform === "youtube") {
                $titleCard.append($(`<i class="nico-youtube mx-1 text-danger" />`));
                $titleCard.append($(`<span />`).text("YouTube"));
            } else if (channelInfo.platform === "twitch") {
                $titleCard.append($(`<i class="nico-twitch mx-1 text-twitch" />`));
                $titleCard.append($(`<span />`).text("Twitch"));
            } else if (channelInfo.platform === "twitcasting") {
                $titleCard.append($(`<i class="nico-twitcasting mx-1 text-twcast" />`));
                $titleCard.append($(`<span />`).text("Twitcasting"));
            }

            $titleCard.append($(`<h5 class="card-title" />`).text(channelInfo.name));
            $cardMain.append($titleCard);
            let $statsCard = $(`<ul class="list-group list-group-flush ${border}" />`)
                .append($(`<li class="list-group-item bg-dark text-white ${border}" />`).text(
                    `Subscribers: ${chanStats.subscriberCount.toLocaleString()}`));
            if (channelInfo.platform !== "twitcasting") {
                $statsCard.append($(`<li class="list-group-item bg-dark text-white ${border}" />`).text(
                    `Views: ${chanStats.viewCount.toLocaleString()}`));
            }
            $cardMain.append($statsCard);
            let channelLink;
            if (channelInfo.platform === "youtube") {
                channelLink = `https://youtube.com/channel/${channelInfo.id}`;
            } else if (channelInfo.platform === "twitch") {
                channelLink = `https://twitch.tv/${channelInfo.id}`;
            } else if (channelInfo.platform === "twitcasting") {
                channelLink = `https://twitcasting.tv/${channelInfo.id}`;
            }
            let $linkCard = $(`<div class="card-body text-center" />`)
                .append($(`<a class="btn btn-primary mx-1" rel="noopener" target="_blank" />`)
                    .attr("href", channelLink).text("Watch"))
                .append($(`<btn class="btn btn-danger mx-1" />`)
                    .attr("onclick", `removeVTuber("${channelInfo.id}", "${channelInfo.platform}")`).text("Remove"))
            $cardMain.append($linkCard);
            $chanCol.append($cardMain);
            // $cardMain.appendTo($groupRows);
            return $chanCol;
        }

        function generateColumn(groupName, groupData) {
            let $topDiv = $(`<div id="${groupName}" class="container-fluid pb-3" />`);
            $topDiv.append($(
                `<h2 class="text-white py-3">${GROUPS_NAME_MAP[groupName]} <span class="badge bg-danger fs-5 fw-normal">${groupData.length}</span></h2>`
            ));
            let $groupRowsYT = $(`<div class="row row-cols-1 row-cols-md-5 g-4 mb-2" />`);
            let $groupRowsTTV = $(`<div class="row row-cols-1 row-cols-md-5 g-4 mb-2" />`);
            let $groupRowsTW = $(`<div class="row row-cols-1 row-cols-md-5 g-4 mb-2" />`);
            let groupedByPlatform = groupBy(groupData, "platform");

            let ytCards = sortBy(get(groupedByPlatform, "youtube", []), "publishedAt").map(createCard);
            let ttvCards = sortBy(get(groupedByPlatform, "twitch", []), "publishedAt").map(createCard);
            let twCards = sortBy(get(groupedByPlatform, "twitcasting", []), "publishedAt").map(createCard);
            if (ytCards.length > 0) {
                ytCards.forEach(($card) => {
                    $groupRowsYT.append($card);
                })
                $topDiv.append($groupRowsYT);
            }
            if (ttvCards.length > 0) {
                ttvCards.forEach(($card) => {
                    $groupRowsTTV.append($card);
                })
                $topDiv.append($groupRowsTTV);
            }
            if (twCards.length > 0) {
                twCards.forEach(($card) => {
                    $groupRowsTW.append($card);
                })
                $topDiv.append($groupRowsTW);
            }
            return $topDiv;
        }

        (async () => {
            console.log("[API] Fetching all channels data...");
            const channelsSets = await getAllChannelsAsync();
            console.log("[API] Grouping results...");
            let unsortedGroupedData = groupBy(channelsSets, "group");
            let groupedData = {};
            Object.keys(unsortedGroupedData).sort().forEach(function (key) {
                groupedData[key] = unsortedGroupedData[key];
            })
            let allJQData = [];

            Object.keys(groupedData).sort().forEach(function (group) {
                $gridModal.append($(
                    `<a class="btn btn-dark btn-darkgrey" href="#${group}" role="button">${GROUPS_NAME_MAP[group]} <span class="badge bg-danger mx-1 rounded-0">${groupedData[group].length}</span></a>`
                ));
                $("#channelGroup").append($(
                    `<option value="${group}" />`
                ).text(group));
            })

            for (let key in groupedData) {
                let value = groupedData[key];
                let $r = generateColumn(key, value);
                allJQData.push($r);
            }
            $loader.fadeOut(500);
            allJQData.forEach(($jqd) => {
                $jqd.show();
                $main.append($jqd);
            })

            var lazyLoadInstance = new LazyLoad({});
            lazyLoadInstance.update();

            $("#channelUrl").attr("disabled", false);
            $("#channelGroup").attr("disabled", false);
            $("#channelGroupCustom").attr("disabled", false);
            $("#btnAddNew").attr("disabled", false);
        })();

        async function removeVTuber(channelId, platform) {
            console.log(`Removal request, ${channelId} ${platform}`);
            let apiRes = await fetch("/v2/vtuber/admin/delete", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Accept": "application/json"
                },
                body: JSON.stringify({
                    channel: channelId,
                    platform: platform
                })
            }).then((res) => res.json());
            if (apiRes.success !== 1) {
                $("#error-modal-text").text(`Failed to process channel, reason: ${apiRes.error}`);
                errorModal.show();
            } else {
                $(`#${channelId}-${platform}`).remove();
            }
        }

        async function addNewVTuber(channelUrl, group, platform) {
            let apiRes = await fetch("/v2/vtuber/admin/add", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Accept": "application/json"
                },
                body: JSON.stringify({
                    channel: channelUrl,
                    group: group,
                    platform: platform
                })
            }).then((res) => res.json());
            if (apiRes.success !== 1) {
                $("#error-modal-text").text(`Failed to process channel, reason: ${apiRes.error}`);
                errorModal.show();
            } else {
                
            }
        }

        function forceMatchChannel(channelUrl, regex) {
            while (true) {
                let res = regex.exec(channelUrl);
                if (res !== null) {
                    return res[1];
                }
            }
        }

        document.getElementById("formvtapi-add").addEventListener("submit", async function (e) {
            e.preventDefault();
            let channelUrl = $("#channelUrl").val();
            let selGroup = $("#channelGroup").find(":selected").text();
            if (selGroup === "Custom") {
                selGroup = $("#channelGroupCustom").val();
            }
            $("#btnAddNew").attr("disabled", true);
            $("#btnAddNewSpinner").removeClass("visually-hidden");

            if (YOUTUBE_RE.test(channelUrl)) {
                let channelId = forceMatchChannel(channelUrl, YOUTUBE_RE);
                await addNewVTuber(channelId, selGroup, "youtube");
            } else if (TWITCASTING_RE.test(channelUrl)) {
                let channelId = forceMatchChannel(channelUrl, TWITCASTING_RE);
                await addNewVTuber(channelId, selGroup, "twitcasting");
            } else if (TWITCH_RE.test(channelUrl)) {
                let channelId = forceMatchChannel(channelUrl, TWITCH_RE);
                await addNewVTuber(channelId, selGroup, "twitch");
            } else {
                $("#error-modal-text").text("Failed to validate channel URL, please provide proper Youtube/Twitch/Twitcasting Channel URL.");
                errorModal.show();
            }
            $("#btnAddNewSpinner").addClass("visually-hidden");
            $("#btnAddNew").attr("disabled", false);
        });
    </script>
</body>

</html>